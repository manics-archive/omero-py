---
language: generic

services:
  - docker

matrix:
  include:
    - os: linux
      env:
        - PLATFORM=docker
    - os: linux
      env:
        - PACKAGE_NAME=omero-py
        - PATH="$HOME/miniconda/bin:$PATH"
        - PLATFORM=miniconda
        - REQUIREMENTS_CHANNEL=manics

install:
  - ./ci/travis-install.sh

script:
  - ./ci/travis-script.sh

deploy:
  - provider: pypi
    user: $PYPI_USER
    password: $PYPI_PASSWORD
    env:
      - PLATFORM=docker
    on:
      tags: true

  # Anaconda builds go to labels/$TRAVIS_BRANCH and can be overwritten
  - provider: script
    skip_cleanup: true
    script: anaconda -t $CONDA_UPLOAD_TOKEN upload $HOME/miniconda/conda-bld/$TRAVIS_OS_NAME-64/$PACKAGE_NAME-*.tar.bz2 --force -l "${TRAVIS_BRANCH}"
    env:
      - PLATFORM=miniconda
    on:
      all_branches: true

  # Anaconda release
  - provider: script
    skip_cleanup: true
    script: anaconda -t $CONDA_UPLOAD_TOKEN upload $HOME/miniconda/conda-bld/$TRAVIS_OS_NAME-64/$PACKAGE_NAME-*.tar.bz2
    env:
      - PLATFORM=miniconda
    on:
      tags: true
